# End-to-End Tests for `binst install`

This directory contains comprehensive end-to-end tests for the `binst install` command, ensuring it achieves full parity with generated installer scripts.

## Overview

The e2e test suite validates that `binst install` behaves identically to the shell scripts generated by `binst gen`. This ensures users can choose either installation method with confidence.

## Test Suites

### 1. Parity Test (`parity_test.sh`)
- Compares installation results between `binst install` and generated scripts
- Tests both latest and specific versions
- Verifies installed binaries are identical (SHA256 comparison)
- Ensures same files are installed in same locations

### 2. Flags Test (`flags_test.sh`)
- Tests all command-line flags:
  - `--bin-dir/-b`: Custom installation directory
  - `--dry-run/-n`: Dry run mode (no actual installation)
  - `--debug`: Debug output
  - Version argument handling

### 3. Environment Test (`env_test.sh`)
- Tests environment variable handling:
  - `BINSTALLER_BIN`: Default installation directory
  - `GITHUB_TOKEN`: GitHub API authentication
  - Priority between flags and environment variables
  - Default directory fallback (`~/.local/bin`)

### 4. Error Test (`error_test.sh`)
- Tests error scenarios:
  - Invalid version numbers
  - Missing/invalid config files
  - Network failures
  - Checksum mismatches
  - Permission denied
  - Disk space issues
  - Concurrent installations

### 5. Platform Test (`platform_test.sh`)
- Tests platform-specific functionality:
  - OS/architecture detection
  - Various archive formats (tar.gz, zip, tar.xz, binary)
  - Rosetta 2 detection on macOS
  - Multi-binary installations
  - Strip components handling
  - Platform-specific rules

## Running Tests

### Run All Tests
```bash
make test-e2e
```

### Run Individual Test Suites
```bash
make test-e2e-parity     # Parity tests only
make test-e2e-flags      # Flags tests only
make test-e2e-env        # Environment tests only
make test-e2e-error      # Error scenario tests only
make test-e2e-platform   # Platform tests only
```

### Run Tests Directly
```bash
./test/e2e/run_all.sh                # Run all tests
./test/e2e/parity_test.sh           # Run specific suite
```

## CI Integration

The e2e tests are automatically run in CI on:
- Ubuntu (latest)
- macOS (latest)

Tests run on every push to main and on all pull requests.

## Test Requirements

- `binst` binary must be built (`make build`)
- Internet connection (for downloading from GitHub)
- `GITHUB_TOKEN` environment variable (optional, helps avoid rate limits)
- Standard Unix tools: bash, sha256sum, mktemp, etc.

## Adding New Tests

1. Create a new test script in `test/e2e/`
2. Follow the existing pattern with colored output and test tracking
3. Add the script to `TEST_SUITES` array in `run_all.sh`
4. Add a make target in the Makefile
5. Update this README

## Test Coverage

The e2e tests ensure:
- ✅ Binary content matches exactly between installation methods
- ✅ All command-line flags work correctly
- ✅ Environment variables are respected
- ✅ Error conditions are handled gracefully
- ✅ Platform detection works on Linux and macOS
- ✅ Various archive formats are supported
- ✅ Atomic installation (no partial installs)
- ✅ Concurrent installation safety

## Troubleshooting

If tests fail:
1. Check you have the latest `binst` binary built
2. Ensure you have internet connectivity
3. Set `GITHUB_TOKEN` if hitting rate limits
4. Check test logs for detailed error messages
5. Run individual test suites to isolate issues
