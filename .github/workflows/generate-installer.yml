name: Generate Official Install Script

on:
  push:
    branches: [main]
    paths: ['.config/binstaller.yml']

permissions:
  contents: write
  pull-requests: write
  attestations: write
  id-token: write

jobs:
  generate-and-attest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build binst
        run: |
          echo "ğŸ”¨ Building binst..."
          go build -o binst ./cmd/binst
          echo "âœ… binst built successfully"

      - name: Generate official install script
        run: |
          echo "ğŸ“„ Generating official install script..."
          ./binst gen -o install.sh
          echo "âœ… Install script generated successfully"

      - name: Test generated script
        run: |
          echo "ğŸ§ª Testing generated install script..."
          
          # Check syntax
          if ! bash -n install.sh; then
            echo "âŒ Generated script has syntax errors"
            exit 1
          fi
          
          # Actually execute the script
          chmod +x install.sh
          ./install.sh
          
          echo "âœ… Script execution test passed"

      - name: Attest install script
        uses: actions/attest-build-provenance@v1
        id: attest
        with:
          subject-path: install.sh

      - name: Get current date
        id: date
        run: echo "date=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: Create PR with attested script
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ğŸ”’ Update official install script with attestation

            Generated from .config/binstaller.yml
            
            ğŸ“‹ Workflow: ${{ github.workflow }}
            ğŸƒ Run ID: ${{ github.run_id }}
            ğŸ”— Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            ğŸ“… Generated: ${{ steps.date.outputs.date }}
            
            ğŸ¤– This commit contains an attested install script generated by the official workflow.
            Users can verify this script with: gh attestation verify install.sh --repo ${{ github.repository }}
          title: "ğŸ”’ Update official install script (attested)"
          body: |
            ## Official Install Script Update
            
            This PR contains the official install script generated from the updated binstaller configuration.
            
            ### ğŸ”’ Security Information
            
            - **âœ… Attested**: Yes, with GitHub build provenance
            - **ğŸƒ Workflow**: `${{ github.workflow }}`
            - **ğŸ“‹ Run ID**: [`${{ github.run_id }}`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **ğŸ“… Generated**: ${{ steps.date.outputs.date }}
            
            ### ğŸ§ª Verification
            
            Users can verify this script with:
            ```bash
            gh attestation verify install.sh --repo ${{ github.repository }}
            ```
            
            ### âš ï¸ Important Notes
            
            - This PR requires attestation verification before merge
            - Only scripts generated by this official workflow should be merged
            - Manual edits to install.sh are not allowed
            
            ğŸ¤– This PR was created automatically and requires attestation verification before merge.
          branch: auto/update-install-script
          delete-branch: true
          labels: |
            automated
            security
            attestation

      - name: Output summary
        run: |
          echo "## ğŸ‰ Workflow Summary"
          echo ""
          echo "âœ… Install script generated successfully"
          echo "ğŸ”’ Attestation created and attached"
          echo "ğŸ“¨ Pull request created for review"
          echo ""
          echo "### Next Steps"
          echo "1. Review the generated PR"
          echo "2. Attestation verification will run automatically"
          echo "3. Merge when all checks pass"
          echo ""
          echo "### Verification Command"
          echo "gh attestation verify install.sh --repo ${{ github.repository }}"