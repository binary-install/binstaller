name: Verify Install Script Attestation

on:
  pull_request:
    branches: [main]
    paths: ['install.sh']

permissions:
  contents: read
  attestations: read
  pull-requests: write

jobs:
  verify-official-attestation:
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify attestation exists and is valid
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Verifying attestation for install.sh..."

          if ! gh attestation verify install.sh --repo ${{ github.repository }} --signer-workflow ${{ github.repository }}/.github/workflows/generate-installer.yml; then
            echo ""
            echo "âŒ ATTESTATION VERIFICATION FAILED"
            echo ""
            echo "This install script does not have a valid attestation or was not generated"
            echo "by the official workflow. Only scripts generated by the official workflow are allowed."
            echo ""
            echo "Expected signer workflow: ${{ github.repository }}/.github/workflows/generate-installer.yml"
            echo ""
            exit 1
          fi

          echo "âœ… Attestation verification passed"

      - name: Test script execution
        run: |
          echo "ðŸ§ª Testing install script execution..."
          chmod +x install.sh
          ./install.sh
          echo "âœ… Script execution test passed"

      - name: Generate verification summary
        if: always()
        run: |
          echo "## ðŸ”’ Attestation Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ… **All security and verification checks passed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ›¡ï¸ Security Verification" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Attestation exists and is valid" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Generated by official workflow" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Script execution test passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**This install script is safe to merge and distribute to users.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Security verification checks failed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”§ How to Fix" >> $GITHUB_STEP_SUMMARY
            echo "1. Ensure the script was generated by the official workflow" >> $GITHUB_STEP_SUMMARY
            echo "2. Check attestation is properly created" >> $GITHUB_STEP_SUMMARY
            echo "3. Verify script execution works correctly" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Verification Command" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "gh attestation verify install.sh --repo ${{ github.repository }} --signer-workflow ${{ github.repository }}/.github/workflows/generate-installer.yml" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
